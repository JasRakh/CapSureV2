# Как сделать максимальное количество запросов (Unlimited-like)

## ⚠️ Важно: Полностью неограниченных запросов не существует

Все API имеют лимиты, но можно значительно увеличить эффективность использования запросов.

## Реализованные оптимизации

### 1. ✅ Кэширование результатов

Приложение автоматически кэширует результаты идентификации таблеток:

- **Одинаковые изображения** не отправляются повторно в API
- Кэш хранится **30 дней**
- Экономит **100% API запросов** для повторных сканирований
- Ограничение: последние 1000 записей (автоматическая очистка старых)

**Как это работает:**

- При сканировании создается hash изображения
- Проверяется кэш перед отправкой в API
- Если найдено - возвращается из кэша мгновенно
- Если нет - запрос к API и сохранение в кэш

### 2. ✅ Автоматический Retry с экспоненциальной задержкой

При ошибке 429 (Rate Limit):

- Автоматически повторяет запрос до 5 раз
- Использует экспоненциальную задержку (1s, 2s, 4s, 8s, 16s)
- Учитывает заголовок `retry-after` от API
- Максимальная задержка: 60 секунд

### 3. ✅ Умный выбор моделей

Приложение использует стратегию для максимизации лимитов:

- Начинает с более дешевых моделей (`gpt-4o-mini`)
- Имеет более высокие rate limits
- Автоматически переключается на другие модели при необходимости

### 4. ✅ Fallback на альтернативные модели

Если одна модель недоступна:

- Автоматически пробует другие модели
- Увеличивает шансы успешного запроса
- Не требует ручного вмешательства

## Как максимизировать количество запросов

### Стратегия 1: Используйте более дешевые модели

Измените модель в `services/openaiService.ts`:

```typescript
const OPENAI_MODEL = process.env.EXPO_PUBLIC_OPENAI_MODEL || 'gpt-4o-mini';
```

**Преимущества:**

- Более высокие rate limits
- Ниже стоимость
- Быстрее ответы
- Больше запросов в минуту

### Стратегия 2: Используйте несколько API ключей

Создайте массив ключей и ротируйте их:

```typescript
const API_KEYS = ['sk-key1...', 'sk-key2...', 'sk-key3...'];

// Ротация ключей при rate limit
```

### Стратегия 3: Upgrade ваш OpenAI план

1. Зайдите на https://platform.openai.com/account/billing
2. Перейдите на более высокий тариф
3. Это увеличит ваши rate limits:
   - **Tier 1** ($5+): ~60 запросов/минуту
   - **Tier 2** ($50+): ~500 запросов/минуту
   - **Tier 3** ($500+): ~5000 запросов/минуту

### Стратегия 4: Используйте кэширование максимально

- Сканируйте разные таблетки (кэш работает для одинаковых)
- Повторные сканирования одной таблетки будут мгновенными
- Кэш автоматически очищается через 30 дней

### Стратегия 5: Реализуйте очередь запросов

Для очень высоких нагрузок можно добавить очередь:

```typescript
// Пример очереди запросов
const requestQueue: Array<() => Promise<void>> = [];
let processing = false;

const processQueue = async () => {
  if (processing || requestQueue.length === 0) return;
  processing = true;
  // Обработка запросов с задержками
  processing = false;
};
```

## Мониторинг использования

### Проверка кэша

```typescript
import { getCacheStats } from './services/openaiService';

const stats = await getCacheStats();
console.log(`Cache: ${stats.entries} entries, ${stats.size} bytes`);
```

### Очистка кэша

```typescript
import { clearPillCache } from './services/openaiService';

await clearPillCache();
```

## Рекомендации для максимального количества запросов

1. **Используйте `gpt-4o-mini`** - самый высокий rate limit
2. **Включите кэширование** - уже реализовано автоматически
3. **Upgrade план OpenAI** - для более высоких лимитов
4. **Мониторьте использование** - https://platform.openai.com/usage
5. **Настройте alerts** - для предупреждения о лимитах

## Ожидаемые результаты

С реализованными оптимизациями:

- **Повторные сканирования**: 0 API запросов (из кэша)
- **Новые сканирования**: 1 API запрос с автоматическим retry
- **При rate limit**: Автоматический retry до 5 раз
- **Экономия**: До 80-90% запросов при повторном использовании

## Альтернативные решения

### Использование Backend Proxy

Для production приложений рекомендуется использовать backend:

1. Создайте backend API
2. Храните API ключи на сервере
3. Реализуйте кэширование на сервере
4. Используйте несколько API ключей с ротацией
5. Добавьте rate limiting на уровне приложения

Это позволит:

- Скрыть API ключи от клиента
- Централизованное кэширование
- Лучший контроль над лимитами
- Аналитика использования

## Итог

Хотя полностью неограниченных запросов не существует, реализованные оптимизации позволяют:

- ✅ Максимизировать эффективность использования лимитов
- ✅ Минимизировать количество реальных API запросов
- ✅ Автоматически обрабатывать rate limits
- ✅ Использовать кэширование для повторных запросов

С этими оптимизациями вы сможете делать значительно больше запросов в рамках ваших лимитов!
